<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="css/synchro.css">
	</head>
	<body>
		<dic class="matrix">
			<div class="channel channel1">
				<div class="note note1"></div>
				<div class="note note2"></div>
				<div class="note note3"></div>
				<div class="note note4"></div>
				<div class="note note5"></div>
				<div class="note note6"></div>
				<div class="note note7"></div>
				<div class="note note8"></div>
				<div class="note note9"></div>
				<div class="note note10"></div>
				<div class="note note11"></div>
				<div class="note note12"></div>
			</div>
			<div class="channel channel2">
				<div class="note note1"></div>
				<div class="note note2"></div>
				<div class="note note3"></div>
				<div class="note note4"></div>
				<div class="note note5"></div>
				<div class="note note6"></div>
				<div class="note note7"></div>
				<div class="note note8"></div>
				<div class="note note9"></div>
				<div class="note note10"></div>
				<div class="note note11"></div>
				<div class="note note12"></div>
			</div>
			<div class="channel channel3">
				<div class="note note1"></div>
				<div class="note note2"></div>
				<div class="note note3"></div>
				<div class="note note4"></div>
				<div class="note note5"></div>
				<div class="note note6"></div>
				<div class="note note7"></div>
				<div class="note note8"></div>
				<div class="note note9"></div>
				<div class="note note10"></div>
				<div class="note note11"></div>
				<div class="note note12"></div>
			</div>
			<div class="channel channel4">
				<div class="note note1"></div>
				<div class="note note2"></div>
				<div class="note note3"></div>
				<div class="note note4"></div>
				<div class="note note5"></div>
				<div class="note note6"></div>
				<div class="note note7"></div>
				<div class="note note8"></div>
				<div class="note note9"></div>
				<div class="note note10"></div>
				<div class="note note11"></div>
				<div class="note note12"></div>
			</div>
			<div class="channel channel5">
				<div class="note note1"></div>
				<div class="note note2"></div>
				<div class="note note3"></div>
				<div class="note note4"></div>
				<div class="note note5"></div>
				<div class="note note6"></div>
				<div class="note note7"></div>
				<div class="note note8"></div>
				<div class="note note9"></div>
				<div class="note note10"></div>
				<div class="note note11"></div>
				<div class="note note12"></div>
			</div>
		</div>
		<audio id="audio" src="mp3/track.mp3" preload="auto" controls="controls" loop></audio>
		<div id="connected">Connected</div>
		<div id="not-connected">Connecting...</div>
		<div id="parsing">Parsing data...</div>
		<div id="autovolume" onclick='toggleAutoVolume()'>Auto volume <span id="autovolume-on">on</span><span id="autovolume-off">off</span></div>
		<div>
			Normal volume: 
			<select id="volumeMax">
				<option value="0">0</option>
				<option value="0.1">01</option>
				<option value="0.2">02</option>
				<option value="0.3">03</option>
				<option value="0.4">04</option>
				<option value="0.5">05</option>
				<option value="0.6">06</option>
				<option value="0.7">07</option>
				<option value="0.8">08</option>
				<option value="0.9">09</option>
				<option value="1.0">10</option>
			</select>
			<br/>
			Quiet hours volume: 
			<select id="volumeMin">
				<option value="0">0</option>
				<option value="0.1">01</option>
				<option value="0.2">02</option>
				<option value="0.3">03</option>
				<option value="0.4">04</option>
				<option value="0.5">05</option>
				<option value="0.6">06</option>
				<option value="0.7">07</option>
				<option value="0.8">08</option>
				<option value="0.9">09</option>
				<option value="1.0">10</option>
			</select>
			<br/>
			Quiet hours start: 
			<select id="startTime">
				<option value="0">0h00</option>
				<option value="1">1h00</option>
				<option value="2">2h00</option>
				<option value="3">3h00</option>
				<option value="4">4h00</option>
				<option value="5">5h00</option>
				<option value="6">6h00</option>
				<option value="7">7h00</option>
				<option value="8">8h00</option>
				<option value="9">9h00</option>
				<option value="10">10h00</option>
				<option value="11">11h00</option>
				<option value="12">12h00</option>
				<option value="13">13h00</option>
				<option value="14">14h00</option>
				<option value="15">15h00</option>
				<option value="16">16h00</option>
				<option value="17">17h00</option>
				<option value="18">18h00</option>
				<option value="19">19h00</option>
				<option value="20">20h00</option>
				<option value="21">21h00</option>
				<option value="22">22h00</option>
				<option value="23">23h00</option>
			</select>
			<br/>
			Quiet hours end: 
			<select id="endTime">
				<option value="0">0h00</option>
				<option value="1">1h00</option>
				<option value="2">2h00</option>
				<option value="3">3h00</option>
				<option value="4">4h00</option>
				<option value="5">5h00</option>
				<option value="6">6h00</option>
				<option value="7">7h00</option>
				<option value="8">8h00</option>
				<option value="9">9h00</option>
				<option value="10">10h00</option>
				<option value="11">11h00</option>
				<option value="12">12h00</option>
				<option value="13">13h00</option>
				<option value="14">14h00</option>
				<option value="15">15h00</option>
				<option value="16">16h00</option>
				<option value="17">17h00</option>
				<option value="18">18h00</option>
				<option value="19">19h00</option>
				<option value="20">20h00</option>
				<option value="21">21h00</option>
				<option value="22">22h00</option>
				<option value="23">23h00</option>
			</select>
		</div>
		<script src="js/socket.io-1.3.7.js"></script>
		<script src="js/synchro/io-handler.js"></script>
		<script src="js/synchro/colors.js"></script>
		<script src="js/synchro/autovolume.js"></script>
		<script>
			var sentMessages = 0;
			var previousTime = 0;

			var NOTE_ON = 0x90;
			var NOTE_OFF = 0x80;
			var CC = 0xB0;

			var colors = [];
			var midiData = [];
			var pos = 0;
			var midiPos = 0;

			var volume = 1.0;

			nb = 0;

			var index = [];

			var currentColors = [];

			var colorsToSend = [];

			function setColorToSend(channel, note, color)
			{
				if (!colorsToSend[channel])
					colorsToSend[channel] = [];
				if (!colorsToSend[channel][note])
					colorsToSend[channel][note] = color;
			}

			function sendColorsToSend()
			{
				if (!colorsToSend.length || updateLocked)
					return;

				for (var c in colorsToSend)
				{
					var colors = colorsToSend[c];

					for (var n in colors)
					{
						var color = colors[n];

						c = parseInt(c);
						n = parseInt(n);

						dispatchColor(c, n, color);
					}
				}

				colorsToSend = [];
			}

			function resetAll(colors)
			{
				colorsToSend = [];

				var getColor = function(x, y)
				{
					if (colors === undefined)
						return 0;

					return colors[x][y];
				}

				for (var x = 0; x < 12; x++)
					for (var y = 0; y < 5; y++)
						setColor(y, x, getColor(x, y));

				sendColorsToSend();
			}

			function getNote(channel, note)
			{
				channel += 1;

				var channelEl = document.getElementsByClassName("channel" + channel)[0];
				
				for(var i = 0; i < channelEl.children.length; ++i)
				{
					var child = channelEl.children[i];
					if (child.className.indexOf("note" + (note + 1)) != -1)
						return child;
				}

				return null;
			}

			function setColor(channel, note, color)
			{
				var el = getNote(channel, note);
				
				color = color & 0x00FFFFFF;

				setColorToSend(channel, note, color);

				if (el)
				{
					color = color.toString(16);
					while(color.length < 6)
						color = "0" + color;

					//console.log(color);

					el.style.background = "#" + color;
				}
			}

			function getData(url, callback)
			{
				var oReq = new XMLHttpRequest();
				oReq.open("GET", url, true);
				oReq.responseType = "arraybuffer";

				oReq.onload = function (oEvent)
				{
					var arrayBuffer = oReq.response; // Note: not oReq.responseText
					if (arrayBuffer)
					{
						var byteArray = new Uint8Array(arrayBuffer);
						callback(byteArray);
					}
				};

				oReq.send(null);
			}

			var dataOffset = 0;

			function readData(data)
			{
				setInterval(readDataCluster, 10, data);
			}

			var currentS = -1;

			var currentColors = [];

			for (var x = 0; x < 12; x++)
			{
				currentColors[x] = [];

				for (var y = 0; y < 5; y++)
					currentColors[x][y] = 0;
			}

			function copyCurrentColors()
			{
				var colors = [];
			
				for (var x = 0; x < 12; x++)
				{
					colors[x] = [];

					for (var y = 0; y < 5; y++)
						colors[x][y] = currentColors[x][y];
				}

				return colors;
			}

			function readDataCluster(data)
			{
				var l = data.length / 8;

				if (dataOffset >= l)
					return;

				for (var i = dataOffset; i < l && i < dataOffset + 4000; ++i)
				{
					var offset = i * 8;

					var t = readUInt32(data, offset);

					var type = data[offset + 4] & 0xFF;
					var channel = data[offset + 5] & 0xFF;
					var data1 = data[offset + 6] & 0xFF;
					var data2 = data[offset + 7] & 0xFF;

					var midiType = 0;

					if (type == 1)
					{
						midiType = data2 == 0 ? NOTE_OFF : NOTE_ON;
						midiType = midiType + channel;

						var color =  getColorFromMidiData(channel, data1, data2);

						var x = data1 % 12;
						var y = channel;

						currentColors[x][y] = color;

						var colorData = {
							t: t,
							x: x,
							y: y,
							color: color
						}

						colors.push(colorData);
						var s = Math.floor(t / 100);

						if (s != currentS)
						{
							var indexData = {
								pos: colors.length - 1,
								colors: copyCurrentColors()
							}

							while(++currentS < s)
								index[currentS] = indexData;

							index[s] = indexData;
						}
					}
					if (type == 2)
					{
						midiType = CC + channel;

						if (data1 == 7)
							volume = data2 / 127.0;
					}
				}

				dataOffset = i;

				var newT = new Date().getTime();

				if (i >= l)
				{
					console.log(newT - oldT);
					document.getElementById('parsing').style['display'] = 'none';
					document.getElementById('audio').style['display'] = 'block';
					audio.play();
				}
			}

			function getColorFromMidiData(channel, note, velocity)
			{
				var octave = Math.floor(note / 12);
				note = note % 12;

				velocity = velocity / 127.0;

				var hsl = defaultColors[channel][note];

				var h = hsl[0];
				var s = hsl[1];
				var l = hsl[2];

				h = h + (octave * 0.1);
				h = h % 1.0;
				l = l * velocity * volume;

				var value = hslToRgb(h, s, l);

				return value;
			}

			function hslToRgb(h, s, l)
			{
				var r, g, b;

			    if (s == 0)
			    {
			        r = g = b = l;
			    }
			    else
			    {
			        var q = l < 0.5 ? l * (1.0 + s) : l + s - l * s;
			        var p = 2.0 * l - q;

			        r = hueToRgb(p, q, h + 1.0 / 3.0);
			        g = hueToRgb(p, q, h);
			        b = hueToRgb(p, q, h - 1.0 / 3.0);
			    }

			    var intR = Math.round(r * 255.0) & 0xFF;
			    var intG = Math.round(g * 255.0) & 0xFF;
			    var intB = Math.round(b * 255.0) & 0xFF;

			    return (intR << 16) + (intG << 8) + intB;
			}
			
			function hueToRgb(p, q, t)
			{
			    if(t < 0.0)
			        t += 1.0;

			    if(t > 1.0)
			        t -= 1.0;

			    if(t < 1.0 / 6.0)
			        return p + (q - p) * 6.0 * t;

			    if(t < 1.0 / 2.0)
			        return q;

			    if(t < 2.0 / 3.0)
			        return p + (q - p) * (2.0 / 3.0 - t) * 6.0;

			    return p;
			}

			function readUInt32(data, offset)
			{
				var b1 = data[offset];
				var b2 = data[offset + 1];
				var b3 = data[offset + 2];
				var b4 = data[offset + 3];

				return (b1 << 24) + (b2 << 16) + (b3 << 8) + b4;
			}

			function displayColors()
			{
				if (pos >= colors.length)
					return;

				var c = colors[pos];
				//var nextColors = pos < colors.length - 1 ? colors[pos + 1] : null;

				var x = c.x;
				var y = c.y;
				
				setColor(y, x, c.color);

				pos += 1;
			}

			function dispatchColor(channel, note, color)
			{
				sentMessages++;

				IoHandler.sendMessage({
					type: 'synchroMessage',
					channel: channel,
					note: note,
					color: color
				});
			}

			var previousTime = 0;
			audio = document.getElementById("audio");

			function timeUpdated()
			{
				var currentTime = (audio.currentTime * 1000);
				var delta = Math.abs(currentTime - previousTime);
				
				if (delta > 1000)
					updatePos();

				var i = 0;
				previousTime = currentTime;

				while(1 && pos < colors.length)
				{
					i++;

					var cols = colors[pos];

					if (cols.t < currentTime)
						displayColors();
					else
						break;
				}

				sendColorsToSend();
			}

			var updateTimeout = 0;
			var updateLocked = false;

			function lockUpdate()
			{
				if (updateTimeout)
					clearTimeout(updateTimeout);

				updateTimeout = setTimeout(function()
				{
					updateLocked = false;
				}, 500);

				updateLocked = true;
			}

			function updatePos()
			{
				lockUpdate();
				resetAll();

				var s = Math.floor(audio.currentTime * 10);

				var i;

				if (s >= index.length)
					i = index[index.length - 1];
				else
					i = index[s];

				pos = i.pos;

				resetAll(i.colors);
			}

			audio.addEventListener("seeked", updatePos);

			setInterval(timeUpdated, 20);
			setInterval(sendColorsToSend, 20);

			var oldT = new Date().getTime();
			getData("mididata.bin", readData);
			
		</script>
	</body>
</html>